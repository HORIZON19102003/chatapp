<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat — Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #02110b;
      --bg-2: #00120a;
      --panel: rgba(0,0,0,0.45);
      --neon: #00ff6a;
      --neon-dim: rgba(0,255,106,0.12);
      --muted: #7fb29a;
      --radius:10px;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color: #c7f7d9;
    }

  html,body{height:100%;margin:0;background:#000;overflow:auto;-webkit-overflow-scrolling:touch}
    /* animated matrix-like background */
    body::before{
      content:'';position:fixed;inset:0;background:
        radial-gradient(ellipse at 10% 10%, rgba(0,255,106,0.04), transparent 8%),
        radial-gradient(ellipse at 90% 80%, rgba(0,255,106,0.03), transparent 18%);
      z-index:0;pointer-events:none;mix-blend-mode:screen;
    }
    /* subtle moving lines */
    .matrix {
      position:fixed;inset:0;z-index:0;opacity:0.12;background-image:linear-gradient(rgba(0,255,106,0.06) 1px, transparent 1px);background-size:1px 24px;filter:blur(1px);
      animation: drift 18s linear infinite;
    }
    @keyframes drift{ from{transform:translateY(0)} to{transform:translateY(-1200px)} }

  .app{position:relative;z-index:1;max-width:980px;margin:12px auto;padding:12px;box-sizing:border-box;width:calc(100% - 24px);min-height:100vh}
  /* card fills viewport height; internal areas use flex so messages list scrolls */
  .card{background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.55));border-radius:12px;overflow:visible;display:flex;flex-direction:column;height:100%;max-height:100vh;border:1px solid rgba(0,255,106,0.06);box-shadow:0 10px 40px rgba(0,0,0,0.6)}

    /* Header */
  .card-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(0,255,106,0.04)}
    .brand{display:flex;align-items:center;gap:14px}
    .brand .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#00250f,#00451c);display:flex;align-items:center;justify-content:center;color:var(--neon);font-weight:800}
  .brand .title{font-size:clamp(16px,2.2vw,20px);font-weight:700;color:var(--neon)}
  .brand .sub{font-size:clamp(11px,1.6vw,13px);color:var(--muted)}

    .header-actions{display:flex;gap:10px;align-items:center}
    .status{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--neon);box-shadow:0 0 12px var(--neon)}

    /* Body */
  .card-body{display:grid;grid-template-columns: 1fr 300px;gap:12px;padding:12px}

    /* Messages area */
  /* messages-panel uses viewport to keep layout consistent on mobile */
  .messages-panel{background:transparent;border-radius:10px;padding:8px;display:flex;flex-direction:column;flex:1;min-height:0;border:1px solid rgba(0,255,106,0.04)}
  .messages-list{flex:1;min-height:0;overflow:auto;padding:8px 10px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:75%;padding:12px 14px;border-radius:12px;backdrop-filter: blur(4px);}
    .msg.me{align-self:flex-end;color:#001b0f}
    .msg.other{align-self:flex-start;color:var(--neon)}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px}
    .msg .text{font-size:14px;line-height:1.45}

    /* Sidebar */
    .sidebar{background:linear-gradient(180deg, rgba(0,0,0,0.26), rgba(0,0,0,0.08));border-radius:10px;padding:12px;height:520px;border:1px solid rgba(0,255,106,0.03)}
    .sidebar h4{margin:4px 0 8px 0;font-size:13px;color:var(--neon)}
    .info{font-size:13px;color:var(--muted);line-height:1.5}

    /* Composer */
  .composer{display:flex;gap:10px;padding:10px;border-top:1px solid rgba(0,255,106,0.03);align-items:center;position:sticky;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.06));backdrop-filter: blur(6px)}
  .composer input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,255,106,0.08);background:rgba(0,0,0,0.36);color:var(--neon);font-size:clamp(14px,2.2vw,16px)}
    .composer input::placeholder{color:rgba(0,255,106,0.45)}
    .composer button{background:var(--neon);color:#001b0f;border:none;padding:10px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .composer button.secondary{background:transparent;border:1px solid rgba(0,255,106,0.08);color:var(--neon)}

    /* Responsive */
    @media (max-width:980px){
      .card-body{grid-template-columns:1fr;}
      .sidebar{order:2;height:auto}
      .messages-panel{max-height:calc(100vh - 240px)}
      .sidebar{display:none}
      .sidebar.visible{display:block;position:fixed;right:12px;top:84px;width:82%;max-width:360px;z-index:12;background:linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.8));border-radius:10px;padding:12px;border:1px solid rgba(0,255,106,0.06)}
      .card{max-width:98vw;margin:8px}
    }

    /* small devices adjustments */
    @media (max-width:520px){
      .brand .logo{width:36px;height:36px}
      .composer button{padding:10px 12px}
      .messages-panel{padding:6px}
    }
    /* safe area for iOS */
    body{padding-bottom:env(safe-area-inset-bottom)}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="card-header">
        <div class="brand">
          <div class="logo">C</div>
          <div>
            <div class="title">Live Chat</div>
            <div class="sub">Anonymous channel</div>
          </div>
        </div>
        <div class="header-actions">
          <div class="status"><span class="dot"></span><span>Connected</span></div>
          <button id="sidebarToggle" class="secondary" style="margin-left:8px;">Info</button>
          <button id="leaveBtn" class="secondary" style="margin-left:8px;">Leave</button>
        </div>
      </div>

      <div class="card-body">
        <div class="messages-panel">
          <div id="messages" class="messages-list" aria-live="polite"></div>

          <div class="composer">
            <input id="messageInput" type="text" placeholder="Write a message and press Enter..." autocomplete="off" />
            <button id="sendBtn">Send</button>
            <button id="changeUserBtn" class="secondary">Change Name</button>
          </div>
        </div>

        <aside class="sidebar">
          <h4>About this room</h4>
          <div class="info">This is a lightweight anonymous chat demo. Messages are not stored locally. Be kind — no abusive language. This UI uses Firebase Firestore for real-time updates.</div>

          <hr style="margin:14px 0;border:none;border-top:1px solid #f0f6fa">
          <h4>Quick commands</h4>
          <div class="info">Press <strong>Enter</strong> to send. Click <strong>Send</strong> to submit. Resize the window — the layout adapts.</div>
        </aside>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config - keep original keys
    const firebaseConfig = {
      apiKey: "AIzaSyAhF-2yoJIvQ619UHN_cc7cYdAUG8eH1r8",
      authDomain: "chat-app-b19ef.firebaseapp.com",
      projectId: "chat-app-b19ef",
      storageBucket: "chat-app-b19ef.appspot.com",
      messagingSenderId: "308122778733",
      appId: "1:308122778733:web:4b496e8a85adc5bc4b9364",
      measurementId: "G-LCPQ08LRLV"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Elements
    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const changeUserBtn = document.getElementById('changeUserBtn');

    // Color palette for usernames
    const palette = ['#ffd166','#06d6a0','#ef476f','#118ab2','#06b6d4','#f59e0b','#a78bfa','#f97316','#34d399','#fb7185'];
    function colorForName(name){
      let h = 0;
      for(let i=0;i<name.length;i++) h = (h<<5) - h + name.charCodeAt(i);
      return palette[Math.abs(h) % palette.length];
    }

    function formatTime(ts){
      if(!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }

  // Create modal dynamically (so it's easy to show/hide)
  // Use sessionStorage so closing the browser/tab clears auth and requires re-entry
  let username = sessionStorage.getItem('chat_username') || '';
  let authorized = sessionStorage.getItem('chat_authorized') === '1';
  // session management: when user 'joins' we set sessionStart; leaving clears it
  let sessionStart = Number(sessionStorage.getItem('chat_session_start')) || null;
  let unsubscribe = null;
    const modal = document.createElement('div');
    modal.style.position = 'fixed'; modal.style.inset = '0'; modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center'; modal.style.background = 'rgba(10,20,30,0.45)'; modal.style.zIndex = 9999;
    modal.innerHTML = `
      <div style="background:linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.8));padding:18px;border-radius:12px;min-width:320px;box-shadow:0 12px 40px rgba(0,255,106,0.06);border:1px solid rgba(0,255,106,0.06);">
        <h3 style="margin:0 0 8px 0;color:var(--neon)">Enter credentials</h3>
        <p style="margin:0 0 10px 0;color:var(--muted);font-size:13px">Password is required to enter this channel.</p>
        <input id="_passwordInput" type="password" placeholder="Password" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,255,106,0.06);margin-bottom:8px;background:rgba(0,0,0,0.45);color:var(--neon);font-size:14px" />
        <input id="_usernameInput" placeholder="Your handle" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,255,106,0.06);margin-bottom:6px;background:rgba(0,0,0,0.45);color:var(--neon);font-size:14px" />
        <div style="height:18px"><span id="_authError" style="color:#ff6b6b;font-size:13px;display:none"></span></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="_usernameSave" style="padding:8px 12px;border-radius:8px;background:var(--neon);color:#001b0f;border:none">Boot</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const usernameInput = document.getElementById('_usernameInput');
    const usernameSave = document.getElementById('_usernameSave');
  function showModal(){
    modal.style.display = 'flex';
    const pw = document.getElementById('_passwordInput');
    const err = document.getElementById('_authError');
    const userFld = document.getElementById('_usernameInput');
    // clear previous error and password field when showing
    if(err){ err.style.display = 'none'; err.textContent = ''; }
    if(pw) pw.value = '';
    if(userFld) userFld.style.borderColor = '';
    if(pw) pw.style.borderColor = '';
    setTimeout(()=> pw && pw.focus(), 80);
  }
  function hideModal(){ modal.style.display = 'none'; }
  // only allow joining if authorized
  if(!authorized){ showModal(); } else { hideModal(); }
    usernameInput.value = username;
    usernameSave.addEventListener('click', ()=>{
      const pw = document.getElementById('_passwordInput').value || '';
      const v = usernameInput.value.trim();
      const err = document.getElementById('_authError');
      // require a non-empty username (no implicit 'Guest')
      if(!v){ if(err){ err.textContent = 'Please enter a username.'; err.style.display = 'inline'; } usernameInput.style.borderColor = '#ff6b6b'; return; }
      // enforce password exactly 'Dian'
      if(pw !== 'Dian'){
        if(err){ err.textContent = 'Incorrect password.'; err.style.display = 'inline'; }
        document.getElementById('_passwordInput').style.borderColor = '#ff6b6b';
        return;
      }
      // authorized (session-only)
      if(err){ err.style.display = 'none'; err.textContent = ''; }
      document.getElementById('_passwordInput').style.borderColor = '';
      usernameInput.style.borderColor = '';
      authorized = true; sessionStorage.setItem('chat_authorized','1');
      username = v; sessionStorage.setItem('chat_username', username);
      // start a new session (sessionStorage so it is cleared on browser close)
      sessionStart = Date.now(); sessionStorage.setItem('chat_session_start', String(sessionStart));
      hideModal(); startListener();
    });
    // allow Enter key in password or username fields
    usernameInput.addEventListener('keydown', e=>{ if(e.key === 'Enter'){ usernameSave.click(); } });
    const passField = document.getElementById('_passwordInput');
    passField.addEventListener('keydown', e=>{ if(e.key === 'Enter'){ usernameSave.click(); } });
  changeUserBtn.addEventListener('click', ()=>{ usernameInput.value = username || ''; showModal(); });

    // Render messages
    function addMessageToList(text, author='Guest', myName='', ts=null){
      const me = (author === myName);
      const wrapper = document.createElement('div');
      wrapper.className = 'msg ' + (me ? 'me' : 'other');

      // author/meta row
      const meta = document.createElement('div'); meta.className = 'meta';
      const badge = document.createElement('span'); badge.style.display='inline-block'; badge.style.width='10px'; badge.style.height='10px'; badge.style.borderRadius='50%'; badge.style.background = colorForName(author); badge.style.marginRight='8px'; badge.style.verticalAlign='middle';
      const nameNode = document.createElement('strong'); nameNode.style.fontWeight='600'; nameNode.style.marginRight='6px';
      if(me){
        // show 'You (username)'
        nameNode.textContent = 'You';
        const small = document.createElement('span'); small.style.fontWeight='400'; small.style.marginLeft='6px'; small.style.color='rgba(255,255,255,0.85)'; small.style.fontSize='12px'; small.textContent = `(${author})`;
        // For contrast when on white (non-me), keep small muted
        if(!wrapper.classList.contains('me')) small.style.color = 'rgba(0,0,0,0.45)';
        meta.appendChild(badge); meta.appendChild(nameNode); meta.appendChild(small);
      } else {
        nameNode.textContent = author;
        const timeNode = document.createElement('span'); timeNode.style.marginLeft='8px'; timeNode.style.color='rgba(0,0,0,0.35)'; timeNode.style.fontSize='11px'; timeNode.textContent = formatTime(ts);
        meta.appendChild(badge); meta.appendChild(nameNode); meta.appendChild(timeNode);
      }

      const txt = document.createElement('div'); txt.className = 'text'; txt.textContent = text;

      // styles: colorful bubbles
      if(me){
        // my message: dark bubble with neon accent
        wrapper.style.background = `linear-gradient(180deg, rgba(0,36,18,0.95), rgba(0,24,12,0.98))`;
        wrapper.style.border = `1px solid ${shadeColor(colorForName(author), -30)}`;
        wrapper.style.color = '#c7ffd6';
        wrapper.style.alignSelf = 'flex-end';
      } else {
        // others: neon on transparent background
        wrapper.style.background = 'transparent';
        wrapper.style.border = `1px solid rgba(0,255,106,0.08)`;
        wrapper.style.boxShadow = `0 6px 18px rgba(0,255,106,0.02)`;
        wrapper.style.alignSelf = 'flex-start';
      }

      wrapper.appendChild(meta); wrapper.appendChild(txt);
      messagesDiv.appendChild(wrapper);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // small color utility to lighten/darken hex
    function shadeColor(hex, percent) {
      const f = hex.slice(1), t = percent < 0 ? 0 : 255, p = Math.abs(percent) / 100;
      const R = parseInt(f.substring(0,2),16), G = parseInt(f.substring(2,4),16), B = parseInt(f.substring(4,6),16);
      const r = Math.round((t - R) * p) + R; const g = Math.round((t - G) * p) + G; const b = Math.round((t - B) * p) + B;
      return `rgb(${r}, ${g}, ${b})`;
    }

    // Firestore listener with session filter: only load messages created after sessionStart
    function startListener(){
      if(unsubscribe) unsubscribe();
      // if we don't have a sessionStart, set it now (fresh join)
    if(!sessionStart) { sessionStart = Date.now(); sessionStorage.setItem('chat_session_start', String(sessionStart)); }
      messagesDiv.innerHTML = '';
      // messages store client 'sessionStamp' as Date.now() when sent; filter by that
      unsubscribe = db.collection('messages')
        .where('sessionStamp', '>=', sessionStart)
        .orderBy('sessionStamp')
        .onSnapshot(snapshot => {
          messagesDiv.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            addMessageToList(data.text, data.username || 'Guest', username, data.timestamp);
          });
        }, err => console.error(err));
    }

    // auto-start listener if session exists
    if(sessionStart) startListener();

    // Send message
    function sendMessage(){
      // enforce active authorization and username from sessionStorage
      if(!authorized || !username) { showModal(); return; }
      const msg = input.value.trim();
      if(!msg) return;
      sendBtn.disabled = true;
  db.collection('messages').add({ text: msg, username: username || 'Guest', timestamp: firebase.firestore.FieldValue.serverTimestamp(), sessionStamp: Date.now() })
        .then(()=>{ input.value=''; input.focus(); sendBtn.disabled=false; })
        .catch(e=>{ console.error(e); sendBtn.disabled=false; });
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', e=>{ if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); } });

    // Leave behavior: clear session and unsubscribe; user must rejoin to see messages
    const leaveBtn = document.getElementById('leaveBtn');
    leaveBtn.addEventListener('click', ()=>{
      if(unsubscribe) unsubscribe(); unsubscribe = null;
      // clear session markers so user must re-auth (password + username) to send or see messages
      sessionStart = null; sessionStorage.removeItem('chat_session_start');
      authorized = false; sessionStorage.removeItem('chat_authorized');
      username = ''; sessionStorage.removeItem('chat_username');
      messagesDiv.innerHTML = '';
      // show modal to rejoin
      showModal();
    });

    // Responsive: sidebar toggle for small screens
    const sidebarEl = document.querySelector('.sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    sidebarToggle?.addEventListener('click', ()=>{
      if(window.innerWidth <= 980){
        sidebarEl.classList.toggle('visible');
      } else {
        // on large screens, briefly flash
        sidebarEl.style.transition = 'box-shadow 0.25s';
        sidebarEl.style.boxShadow = '0 6px 20px rgba(0,255,106,0.05)';
        setTimeout(()=> sidebarEl.style.boxShadow = '', 400);
      }
    });

    // Ensure composer visible when virtual keyboard opens on mobile (best-effort)
    window.addEventListener('resize', ()=>{
      // scroll messages area to bottom so composer remains visible
      setTimeout(()=> messagesDiv.scrollTop = messagesDiv.scrollHeight, 200);
    });

    // Tap the messages area to hide sidebar on mobile
    messagesDiv.addEventListener('click', ()=>{ if(window.innerWidth <= 980) sidebarEl.classList.remove('visible'); });

    // Ensure on orientation change we adjust heights and scroll
    window.addEventListener('orientationchange', ()=>{
      setTimeout(()=> messagesDiv.scrollTop = messagesDiv.scrollHeight, 300);
      // hide sidebar overlay on orientation change for clarity
      if(window.innerWidth <= 980) sidebarEl.classList.remove('visible');
    });

    // When page becomes visible again, scroll to bottom
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(()=> messagesDiv.scrollTop = messagesDiv.scrollHeight, 200); });

    // After loading, ensure messages area fills and is scrolled
    window.addEventListener('load', ()=> setTimeout(()=> messagesDiv.scrollTop = messagesDiv.scrollHeight, 200));
  </script>
</body>
</html>
